{% load static %}
{% load humanize %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panel | Barbererick</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{% static 'css/style.css' %}" rel="stylesheet">
</head>

<body class="bg-black text-white img_fondo panel-fondo">

<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand">Panel de Citas</span>
    <div>
      <a class="btn btn-outline-light btn-sm" href="{% url 'panel_calendario' %}">Calendario</a>
      <a class="btn btn-outline-light btn-sm me-2" href="/Agendamiento/">Ver sitio</a>
      <a class="btn btn-warning btn-sm" href="{% url 'logout' %}">Cerrar sesión</a>
    </div>
  </div>
</nav>

<!-- Botones semana (se mantienen) -->
<div class="d-flex justify-content-center gap-2 flex-wrap mb-2">
  <a class="btn btn-sm {{ selected_date|default:''|yesno:'btn-outline-warning,btn-warning' }}"
     href="?{% if q %}q={{ q }}&{% endif %}{% if servicio_sel %}servicio={{ servicio_sel }}&{% endif %}{% if estado_sel %}estado={{ estado_sel }}&{% endif %}">
    Todos
  </a>

  {% for w in week_days %}
    <a class="btn btn-sm {% if w.value == selected_date %}btn-warning{% else %}btn-outline-warning{% endif %}"
       href="?fecha={{ w.value }}{% if q %}&q={{ q }}{% endif %}{% if servicio_sel %}&servicio={{ servicio_sel }}{% endif %}{% if estado_sel %}&estado={{ estado_sel }}{% endif %}">
      {{ w.label }}
    </a>
  {% endfor %}
</div>

<p class="text-center text-white-50 mb-3">
  {% if selected_date %}
    Mostrando citas del <strong>{{ selected_date|date:"d-m-Y" }}</strong>.
  {% else %}
    Mostrando <strong>todas las citas</strong>.
  {% endif %}
</p>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">Hola, {{ request.user.username }}</h4>
  </div>

  <!-- FILTROS (sin dropdown "Todos los días") -->
  <form class="row g-2 mb-3" method="get">
    <div class="col-sm-4">
      <input type="text" class="form-control" name="q" value="{{ q }}" placeholder="Buscar por nombre o RUT">
    </div>

    <div class="col-sm-3">
      <input type="date" class="form-control" name="fecha" value="{{ selected_date|default:'' }}">
    </div>

    <div class="col-sm-3">
      <select class="form-select" name="servicio">
        <option value="">Todos los servicios</option>
        {% for s in servicios %}
          <option value="{{ s.id }}" {% if servicio_sel == s.id|stringformat:"s" %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-sm-2 d-grid">
      <button class="btn btn-outline-light">Filtrar</button>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle">
      <thead>
        <tr>
          <th>ID</th>
          <th>Cliente</th>
          <th>RUT</th>
          <th>Día</th>
          <th>Fecha</th>
          <th>Hora</th>
          <th>Servicio</th>
          <th>Agregados</th>
          <th>Total</th>
          <th>Estado</th>
          <th></th>
        </tr>
      </thead>

      <tbody>
        {% for c in citas %}
          <tr>
            <td>{{ c.id }}</td>
            <td>{{ c.usuario_horario.nombre }}</td>
            <td>{{ c.usuario_horario.rut }}</td>
            <td>{{ c.dia_horario }}</td>
            <td>{% if c.fecha %}{{ c.fecha|date:"d-m-Y" }}{% else %}—{% endif %}</td>
            <td>{{ c.hora_horario }}</td>
            <td>{{ c.Tipo_servicio.nombre }}</td>

            <td>
              {% with adds=c.agregados.all %}
                {% if adds %}
                  {% for a in adds %}
                    <span class="badge bg-secondary">{{ a.nombre }}</span>
                  {% endfor %}
                {% else %}
                  —
                {% endif %}
              {% endwith %}
            </td>

            <td>
              ${{ c.total|intcomma }}
            </td>

            <td>
              {% if c.estado == 'A' %}
                <span class="badge bg-success">Atendida</span>
              {% elif c.estado == 'C' %}
                <span class="badge bg-danger">Cancelada</span>
              {% else %}
                <span class="badge bg-secondary">Pendiente</span>
              {% endif %}
            </td>

            <td>
              <form method="post" action="{% url 'panel_set_estado' c.id %}">
                {% csrf_token %}
                <select name="estado" class="form-select form-select-sm d-inline w-auto">
                  <option value="P" {% if c.estado == 'P' %}selected{% endif %}>Pendiente</option>
                  <option value="A" {% if c.estado == 'A' %}selected{% endif %}>Atendida</option>
                  <option value="C" {% if c.estado == 'C' %}selected{% endif %}>Cancelada</option>
                </select>
                <button class="btn btn-sm btn-outline-light">OK</button>
              </form>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="11" class="text-center">Sin resultados.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="d-flex gap-2">
      <a class="btn btn-warning"
         href="{% url 'panel_export' %}?q={{ q }}&servicio={{ servicio_sel }}{% if selected_date %}&fecha={{ selected_date }}{% endif %}">
        Exportar CSV
      </a>
    </div>

    <nav aria-label="Paginación">
      <ul class="pagination pagination-sm justify-content-center">
        {% if citas.has_previous %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ citas.previous_page_number }}&q={{ q }}&servicio={{ servicio_sel }}{% if selected_date %}&fecha={{ selected_date }}{% endif %}">
              «
            </a>
          </li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">
            Página {{ citas.number }} de {{ citas.paginator.num_pages }}
          </span>
        </li>

        {% if citas.has_next %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ citas.next_page_number }}&q={{ q }}&servicio={{ servicio_sel }}{% if selected_date %}&fecha={{ selected_date }}{% endif %}">
              »
            </a>
          </li>
        {% endif %}
      </ul>
    </nav>

  </div>
</div>

</body>
</html>