{% extends "base.html" %}
{% load static %}

{% block title %}Agendar cita | Barbererick{% endblock %}

{% block content %}
<div class="agendar-page">

  <!-- Carrusel -->
  <div id="carouselHero" class="carousel slide mb-4" data-bs-ride="carousel">
    <div class="carousel-indicators">
      <button type="button" data-bs-target="#carouselHero" data-bs-slide-to="0" class="active"></button>
      <button type="button" data-bs-target="#carouselHero" data-bs-slide-to="1"></button>
      <button type="button" data-bs-target="#carouselHero" data-bs-slide-to="2"></button>
    </div>
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img src="{% static 'imagenes/carrusel1.png' %}" class="d-block w-100" alt="">
      </div>
      <div class="carousel-item">
        <img src="{% static 'imagenes/carrusel3.png' %}" class="d-block w-100" alt="">
      </div>
      <div class="carousel-item">
        <img src="{% static 'imagenes/carrusel31.png' %}" class="d-block w-100" alt="">
      </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#carouselHero" data-bs-slide="prev">
      <span class="carousel-control-prev-icon"></span>
      <span class="visually-hidden">Anterior</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselHero" data-bs-slide="next">
      <span class="carousel-control-next-icon"></span>
      <span class="visually-hidden">Siguiente</span>
    </button>
  </div>

  {% if hoy_cerrado %}
    <div class="text-center mb-3">
      <h5 class="m-0" style="color:#f59e0b; font-weight:700; letter-spacing:1px;">
        HOY {{ hoy_nombre|upper }} CERRADO
      </h5>
    </div>
  {% endif %}

  <!-- Form centrado -->
  <div class="container py-4 reveal stagger">
    {% if messages %}
      <div class="mensaje-error-animado animate__animated animate__fadeInDown">
        {% for message in messages %}
          {{ message }}
        {% endfor %}
      </div>
    {% endif %}

    <div class="row justify-content-center stagger">
      <div class="col-12 col-md-8 col-lg-5">
        <div class="card agendar-card p-4">
          <h1 class="h4 mb-3 text-center">Agendar Cita</h1>

          <form action="/RegistrarAgendamiento" method="post" id="formAgendar">
            {% csrf_token %}

            <div class="mb-3">
              <label class="form-label">Nombre del Cliente</label>
              <input type="text" class="form-control" id="name" name="name" placeholder="Ingresa tu nombre" required>
            </div>

            <div class="mb-3">
              <label class="form-label">RUT</label>
              <input type="text" class="form-control" id="rut" name="rut" placeholder="Ej: 12.345.678-9">
            </div>

            <div class="mb-3">
              <label class="form-label">Número de Teléfono</label>
              <input type="tel" class="form-control" id="telefono" name="telefono" placeholder="Ej: +56912345678" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Servicio Principal</label>
              <select class="form-select" id="servicio_base" name="servicio_base_id" required>
                <option value="" disabled selected>Seleccione un Servicio</option>

                {# ✅ IMPORTANTE: data-precio desde tu modelo Tipo_servicio.precio_servicio #}
                {% for x in tipos_base %}
                  <option value="{{ x.id }}" data-precio="{{ x.precio_servicio }}">{{ x.nombre }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Agregados (opcional)</label>
              <div class="d-grid gap-2">
                {% for a in tipos_addons %}
                <label class="d-flex align-items-center gap-2">
                  <input type="checkbox"
                  class="form-check-input addon-check"
                  name="addons_ids"
                  value="{{a.id}}"
                  data-precio="{{a.precio_servicio}}">
                  <span>{{ a.nombre }} ({{ a.precio_servicio }})</span>
                </label>
                 {% endfor %}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Día de la Semana (semana actual)</label>
              <select class="form-select" id="diaSelect" required>
                <option value="" disabled selected>Seleccione un día</option>
                {% for x in dias_disponibles %}
                  {% if x.dia_Dias %}
                    <option value="{{ x.dia_Dias }}" data-dia-id="{{ x.id }}">{{ x.dia_Dias }}</option>
                  {% else %}
                    <option value="{{ x }}" data-dia-id="">{{ x }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>

            <input type="hidden" id="fecha" name="fecha">

            <div class="mb-3">
              <label class="form-label">Horas disponibles</label>
              <select class="form-select" id="hora" name="hora" required>
                <option value="" disabled selected>Seleccione una hora</option>
              </select>
              <div class="form-text text-secondary">
                *El metodo de Pago es Presencial
              </div>
            </div>

            {# ✅ NUEVA CASILLA: precio automático según el servicio #}
            <div class="mb-3">
              <label class="form-label">Valor del servicio</label>
              <input type="text" class="form-control" id="precio_servicio" value="—" readonly>
            </div>

            <button class="btn btn-primary w-100">Agendar</button>
          </form>
          <hr class="my-4">

            <div id="boxOcupadas" class="mt-3" style="display:none;">
              <h6 class="mb-2" style="font-weight:700;">HORAS NO DISPONIBLES</h6>

              <div class="table-responsive">
                <table class="table table-dark table-sm align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Día</th>
                      <th>Fecha</th>
                      <th>Hora</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyOcupadas"></tbody>
                </table>
              </div>

              <div id="ocupadasVacio" class="text-white-50 small mt-2" style="display:none;">
                No hay horas ocupadas para este día.
              </div>
            </div>


          

        </div>
      </div>
    </div>
  </div>

</div>

<style>
.mensaje-error-animado {
    max-width: 400px;
    margin: 10px auto 15px auto;   /* centrado y pegado al form */
    padding: 8px 16px;
    background: #ffd4d4;            /* rojo clarito */
    color: #7a1111;
    border: 1px solid #ff9c9c;
    border-radius: 8px;
    font-size: 0.9rem;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);

    /* Animaciones */
    animation: slideDown 0.4s ease-out, fadeOut 0.4s ease-in 4s forwards;
}

/* Entra desde arriba */
@keyframes slideDown {
    from { transform: translateY(-10px); opacity: 0; }
    to   { transform: translateY(0); opacity: 1; }
}

/* Se desvanece después de unos segundos */
@keyframes fadeOut {
    to { opacity: 0; transform: translateY(-5px); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const servicioBaseSel = document.getElementById('servicio_base');
  const diaUI       = document.getElementById('diaSelect');
  const fechaHidden = document.getElementById('fecha');
  const horasSel    = document.getElementById('hora');

  const boxOcupadas   = document.getElementById('boxOcupadas');
  const tbodyOcupadas = document.getElementById('tbodyOcupadas');
  const ocupadasVacio = document.getElementById('ocupadasVacio');

  const precioInput = document.getElementById('precio_servicio');

  const diasIdx = { "Lunes":1, "Martes":2, "Miércoles":3, "Jueves":4, "Viernes":5, "Sábado":6 };

  function formatCLP(n){
    const val = Number(n || 0);
    return "$" + val.toLocaleString("es-CL");
  }

  function totalAddons(){
    let sum = 0;
    document.querySelectorAll(".addon-check:checked").forEach(ch => {
      sum += Number(ch.dataset.precio || 0);
    });
    return sum;
  }

  function actualizarPrecioTotal(){
    const opt = servicioBaseSel.options[servicioBaseSel.selectedIndex];
    const base = opt ? Number(opt.dataset.precio || 0) : 0;
    const addons = totalAddons();
    const total = base + addons;
    precioInput.value = base ? formatCLP(total) : "—";
  }

  function mondayBase(d){
    const dow = d.getDay();
    const base = new Date(d);
    if (dow === 0) base.setDate(d.getDate() + 1);
    else base.setDate(d.getDate() - (dow - 1));
    base.setHours(0,0,0,0);
    return base;
  }

  function fechaDeDiaSemana(nombreDia){
    const idx = diasIdx[nombreDia];
    if(!idx) return "";
    const hoy = new Date();
    const monday = mondayBase(hoy);
    const target = new Date(monday);
    target.setDate(monday.getDate() + (idx - 1));
    const y = target.getFullYear();
    const m = String(target.getMonth()+1).padStart(2,'0');
    const d = String(target.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }

  function bloquearDiasPasados(){
    const hoy = new Date(); hoy.setHours(0,0,0,0);
    [...diaUI.options].forEach(opt => {
      const nombre = opt.value;
      if (!diasIdx[nombre]) return;
      const f = fechaDeDiaSemana(nombre);
      const [Y,M,D] = f.split('-').map(n=>parseInt(n,10));
      const target = new Date(Y, M-1, D);
      opt.disabled = target < hoy;
    });
  }

  async function cargarHoras(){
    horasSel.innerHTML = `<option disabled selected>Cargando...</option>`;
    const servicio = servicioBaseSel.value;
    const fecha = fechaHidden.value;

    if(!servicio || !fecha){
      horasSel.innerHTML = `<option disabled selected>Seleccione una hora</option>`;
      return;
    }

    try{
      const res = await fetch(`/api/slots?fecha=${encodeURIComponent(fecha)}&servicio=${encodeURIComponent(servicio)}`);
      const data = await res.json();

      horasSel.innerHTML = '';
      const lista = Array.isArray(data.slots) ? data.slots : [];

      if(!lista.length){
        horasSel.innerHTML = `<option disabled selected>No hay horas disponibles</option>`;
        return;
      }

      const placeholder = document.createElement('option');
      placeholder.disabled = true;
      placeholder.selected = true;
      placeholder.textContent = "Seleccione una hora";
      placeholder.value = "";
      horasSel.appendChild(placeholder);

      lista.forEach(h => {
        const opt = document.createElement('option');
        opt.value = h;
        opt.textContent = h;
        horasSel.appendChild(opt);
      });

    }catch(e){
      horasSel.innerHTML = `<option disabled selected>Error cargando horas</option>`;
    }
  }

  async function cargarOcupadas(){
    const fecha = fechaHidden.value;
    if(!fecha){
      boxOcupadas.style.display = "none";
      return;
    }

    try{
      const res = await fetch(`/api/ocupadas?fecha=${encodeURIComponent(fecha)}`);
      const data = await res.json();

      const rows = Array.isArray(data.rows) ? data.rows : [];
      tbodyOcupadas.innerHTML = "";
      boxOcupadas.style.display = "block";

      if(!rows.length){
        ocupadasVacio.style.display = "block";
        return;
      }

      ocupadasVacio.style.display = "none";

      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.dia || ""}</td>
          <td>${r.fecha || ""}</td>
          <td>${r.hora || ""}</td>
        `;
        tbodyOcupadas.appendChild(tr);
      });

    }catch(e){
      boxOcupadas.style.display = "none";
    }
  }

  // Eventos
  diaUI.addEventListener('change', () => {
    const nombreDia = diaUI.value;
    fechaHidden.value = fechaDeDiaSemana(nombreDia);
    if(servicioBaseSel.value) cargarHoras();
    cargarOcupadas();
  });

  servicioBaseSel.addEventListener('change', () => {
    actualizarPrecioTotal();
    if(fechaHidden.value) cargarHoras();
    cargarOcupadas();
  });

  document.querySelectorAll(".addon-check").forEach(ch => {
    ch.addEventListener("change", actualizarPrecioTotal);
  });

  // Init
  bloquearDiasPasados();
  actualizarPrecioTotal();

  const first = [...diaUI.options].find(o => o.value && !o.disabled);
  if (first){
    diaUI.value = first.value;
    diaUI.dispatchEvent(new Event('change'));
  }
});
</script>

{% endblock %}
